<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        form {
            margin: 0 auto;
            padding: 1em;
        }

        ul {
            list-style: none;
            margin: 0
        }

        ul:nth-child(n + 1) {
            padding-left: 1em;
        }

        form li+li {
            margin-top: 1em
        }

        label {
            text-align: right;
        }

        input {
            font: 1em sans-serif;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #999
        }

        input:focus,
        textarea:focus {
            border-color: #000
        }

        .button {
            margin-top: 1em;
        }

        button {
            margin-left: .5em
        }
    </style>
</head>

<body>
    <form id="form">
        <ul>
        </ul>
        <ul>
            <li class="button">
                <button id="submit" type="submit">Добавить</button>
            </li>
        </ul>
    </form>

    <script>
        const requestSkel = {
            parentID: null,
            childKey: "№",
            value: {}
        }
        
        const inputSkel = [
            {
                name: "№",
                input: { tag: "input", attrs: {type: "text"} }
            },
            {
                name: "Производитель/дочерняя компания/дистрибьютор/СПК",
                input: { tag: "input", attrs: {type: "text"} }
            },
            {
                name: "подтверждающий документ",
                "inputs": [
                    {
                        name: "производитель",
                        input: { tag: "input", attrs: {type: "text"} }
                    },
                    {
                        name: "наименование",
                        input: { tag: "input", attrs: {type: "text"} }
                    },
                    {
                        name: "№",
                        input: { tag: "input", attrs: {type: "text"} }
                    },
                    {
                        name: "наименование товара",
                        input: { tag: "input", attrs: {type: "text"} }
                    },
                    {
                        name: "ТН ВЭД (6 знаков)",
                        input: { tag: "input", attrs: {type: "text"} }
                    },
                    {
                        name: "дата",
                        input: { tag: "input", attrs: {type: "text"} }
                    },
                    {
                        name: "срок",
                        input: { tag: "input", attrs: {type: "text"} }
                    },
                    {
                        name: "подтверждение на сайте уполномоченного органа",
                        input: { tag: "input", attrs: {type: "text"} }
                    },
                ]
            }
        ]
        

        const form = document.querySelector("#form")
        const firstUl = document.querySelector("#form ul")
        const submitButton = document.querySelector("#submit")

        populateForm(firstUl, inputSkel, "");

        form.addEventListener('submit', e => {
            submitButton.disabled = true
            e.preventDefault()

            const formData = new FormData(form)
            const jsonBody = Object.fromEntries(formData)
            const reqJSON = createNestedJSON(jsonBody)

            if ("parentID" in reqJSON) {
                requestSkel.parentID = reqJSON.parentID
                delete reqJSON.parentID
            }

            requestSkel.value = reqJSON
            fetch('http://localhost:8082/sheets/records', {
                method: 'POST',
                headers: {
                    authorization: 'Bearer <?!= token ?>',
                    'x-sheet-name': parseInt('<?!= sheet_name ?>'),
                    'x-sheet-id': parseInt('<?!= sheet_id ?>')
                },
                body: JSON.stringify(requestSkel),
            })
            .finally(() => {
                submitButton.disabled = false;
            });
        })

        function populateForm(parent, payload, prefix) {
            for (const elem of payload) {
                if ('inputs' in elem) {
                    const label = document.createElement('p');
                    label.innerText = elem.name;

                    const ul = document.createElement('ul');

                    parent.appendChild(label);
                    parent.appendChild(ul);
                    populateForm(ul, elem.inputs, `${prefix}.${elem.name}`);
                } else {
                    const li = document.createElement('li');

                    const label = document.createElement('label');
                    label.setAttribute('for', `${prefix}.${elem.name}`);
                    label.innerText = elem.name;

                    const input = document.createElement(elem.input.tag);
                    setAttributes(input, elem.input.attrs);
                    setOptions(input, elem.input.options);

                    input.setAttribute('id', `${prefix}.${elem.name}`);

                    const inputName = elem.key ?? elem.name;
                    input.setAttribute('name', `${prefix}.${inputName}`);

                    li.appendChild(label);
                    li.appendChild(input);

                    parent.appendChild(li);
                }
            }
        }

        function setAttributes(el, attrs) {
            if (!attrs) {
                return;
            }

            for (const [key, value] of Object.entries(attrs)) {
                el.setAttribute(key, value);
            }
        }

        function setOptions(el, options) {
            if (!options) {
                return;
            }

            for (const option of options) {
                const optionElem = document.createElement('option');
                optionElem.setAttribute('value', option);
                optionElem.innerText = option;

                el.appendChild(optionElem);
            }
        }

        function createNestedJSON(value) {
            return Object.entries(value).reduce((result, [key, value]) => {
                setNestedKey(result, key, value);
                return result;
            }, {});
        }

        function setNestedKey(obj, k, v) {
            const keys = k.split('.');

            let temp = obj;
            for (const key of keys) {
                if (!key) {
                    continue;
                }
                if (!(key in temp)) {
                    temp[key] = {};
                }

                if (key === keys[keys.length - 1]) {
                    temp[key] = v;
                }

                temp = temp[key];

            }

            return obj;
        }
    </script>
</body>

</html>